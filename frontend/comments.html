<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/cities.css" />
    <link rel="stylesheet" href="/places.css" />
    <title>Comments</title>
  </head>
  <body>
    <div class="makeItFixed">
      <nav class="navbar nav-pills justify-content-around bg-light">
        <a class="navbar-brand fs-2 fw-semibold" href="#"
          >Comments <span id="countrycountry_name"></span
        ></a>
        <div class="auth-container d-flex gap-4 align-items-center w-20"></div>
      </nav>
    </div>
    <div class="d-flex justify-content-center">
      <div class="container mx-lg-5 mx-3 my-3">
        <div class="text-end">
          <a
            data-bs-toggle="modal"
            class="btn bg-black text-white me-2 m-3"
            id="btn-add"
            >Add Comment</a
          >
        </div>
        <div id="comments-container" class="row row-cols-10"></div>
      </div>
    </div>
    <div
      class="modal fade"
      id="add_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Add Your Comment
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="card-body d-flex flex-column">
              <form>
                <div class="mb-3">
                  <textarea
                    class="form-control"
                    id="commentAdd"
                    rows="3"
                  ></textarea>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="add-submit"
              class="btn bg-black text-white"
            >
              Add Comment
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="reply_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Add Your Reply
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="card-body d-flex flex-column">
              <form>
                <div class="mb-3">
                  <textarea
                    class="form-control"
                    id="replyAdd"
                    rows="3"
                  ></textarea>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="reply-submit"
              class="btn bg-black text-white"
            >
              Reply
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Login --------------------------------------------------------------->
    <div
      class="modal fade"
      id="login_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              <div class="d-flex">
                <h5>Log in</h5>
              </div>
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form class="row g-3">
              <div class="col-12">
                <label for="loginEmail" class="form-label">Email address</label>
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  required
                />
              </div>
              <div class="col-12">
                <label for="loginPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  required
                />
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit">Login</button>
                <button
                  type="button"
                  class="btn btn-secondary signup-btn"
                  id="signup-btn"
                  data-bs-dismiss="modal"
                >
                  Don't have an account yet? Sign up
                </button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Signup--------------------------------------------------------------->
    <div
      class="modal fade"
      id="signup_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              <div class="d-flex">
                <h5>Sign Up</h5>
              </div>
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form class="row g-3">
              <div class="col-12">
                <label for="signupUsername" class="form-label">Your name</label>
                <input
                  type="text"
                  class="form-control"
                  id="signupUsername"
                  required
                />
              </div>
              <div class="col-12">
                <label for="signupEmail" class="form-label"
                  >Email address</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="signupEmail"
                  required
                />
              </div>
              <div class="col-12">
                <label for="signupPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="signupPassword"
                  required
                />
              </div>
              <div class="col-12">
                <button class="btn btn-primary signup-submit-btn" type="submit">
                  Sign Up
                </button>
                <button
                  type="button"
                  class="btn btn-secondary login-btn"
                  id="login-btn"
                  data-bs-dismiss="modal"
                >
                  Already have an account? Login
                </button>
              </div>
              <div class="signupError"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://kit.fontawesome.com/118e30abce.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      let data = "";
      let countryName = "";
      let cityName = "";
      let placeName = "";
      let comments = [];
      let users = [];
      let user = JSON.parse(localStorage.getItem("user"));
      console.log(user);
      let userId = user?.userId;
      const apiUrl = "https://jsonblob.com/api/1213499724727705600";
      const userApiUrl = "https://jsonblob.com/api/1213602404489879552";

      //fetch all data
      Promise.all([axios.get(apiUrl), axios.get(userApiUrl)])
        .then(function (res) {
          data = res[0].data;
          users = res[1].data;
          countryName = getQueryParam("country");
          cityName = getQueryParam("city");
          placeName = getQueryParam("place");
          comments = findComments(countryName, cityName, placeName);
          displayComments(comments);
        })
        .catch(function (err) {
          console.log(err);
        });

      function getQueryParam(key) {
        let queryParams = new URLSearchParams(window.location.search);
        return queryParams.has(key) ? queryParams.get(key) : null;
      }

      function findComments(countryName, cityName, placeName) {
        const country = data.find((country) => country.country === countryName);
        if (!country) {
          console.log("country not found");
          return;
        }
        const city = country.cities.find((city) => city.city === cityName);
        if (!city) {
          console.log("city not found");
          return;
        }
        const place = city.places.find((place) => place.place === placeName);
        if (!place) {
          console.log("place not found");
          return;
        }
        return place.comments;
      }

      function getUser(userId) {
        console.log(userId);
        const neededUser = users.find((user) => user.userId === userId);
        return neededUser;
      }

      function generateComment(comment) {
        let repliesHtml = "";
        if (comment.replies && comment.replies.length > 0) {
          for (let reply of comment.replies) {
            let replyUser = getUser(reply.userId);
            let replyUsername = replyUser ? replyUser.name : "Unknown User";
            repliesHtml += `
                <div style="margin-left: 50px;">
                    <div class="card  mb-3 mx-auto">
                    <div class="card-body d-flex justify-content-between">
                            <div class="d-flex flex-column align-items-start">
                                <div class='d-flex gap-2'>
                                    <i class="bi bi-person-circle "></i>
                                    <h6 class="card-title">${replyUsername}</h6>    
                                </div>
                                <p class="card-text">${reply.reply}</p>
                            </div>
                    </div>
                </div>
                </div>`;
          }
        }
        let commentUser = getUser(comment.userId);
        let commentUsername = commentUser ? commentUser.name : "Unknown User";

        const commentCard = `
           <div>
             <div class="card  mb-3 mx-auto">
               <div class="card-body ">
                    <div class="">
                        <div class='d-flex gap-2'>
                                    <i class="bi bi-person-circle "></i>
                                    <h5 class="card-title">${commentUsername}</h5>    
                                </div>
                       
                        <p class="card-text">${comment.comment}</p>
                    </div>
                    <div class="d-flex align-items-center gap-5 mt-2">
                        <a
                            data-bs-toggle="modal"
                            class="btn bg-black text-white reply-btn d-flex gap-1"
                            id="${comment.commentId}"
                            ><i class="bi bi-reply-fill"></i>Reply</a
                        >
                       
                    </div>
                </div>
            </div>
            <div class="replies ">
                ${repliesHtml}
            </div>
            </div>`;
        return commentCard;
      }

      function handleUpvote(commentId) {
        const comment = comments.find((cmt) => cmt.commentId === commentId);
        if (comment) {
        }
      }

      function handleDownvote(commentId) {
        const comment = comments.find((cmt) => cmt.commentId === commentId);
        if (comment) {
        }
      }

      function displayComments(comments) {
        for (let i = 0; i < comments.length; i++) {
          document.getElementById("comments-container").innerHTML +=
            generateComment(comments[i]);
        }
      }

      function updateJsonData(updatedData) {
        return axios
          .put(apiUrl, updatedData)
          .then((res) => {
            console.log(res.data);
          })
          .catch((err) => {
            console.log(err);
          });
      }

      function generateCommentId() {
        return new Date().getTime();
      }

      function checkUserInLocalStorage() {
        const user = localStorage.getItem("user");
        const navbar = $(".navbar");
        const authContainer = navbar.find(".auth-container");
        if (user) {
          const username = JSON.parse(user).name;
          authContainer.html(`
            <div>Hi, ${username}</div>
            <button class = "btn btn-dark"id="logoutBtn">Logout</button>
            `);
        } else {
          authContainer.html(`
             <button class ="btn btn-dark" data-bs-toggle="modal" data-bs-target="#login_modal" id="loginBtn">Login</button>
             <button class = "btn btn-dark" data-bs-toggle="modal" data-bs-target="#signup_modal" id="signupBtn">Sign Up</button>
            `);
        }
      }

      function loginUser(email, password) {
        const foundUser = users.find(
          (user) => user.email === email && user.password === password
        );
        if (foundUser) {
          const { userId, name, email } = foundUser; // Destructure user properties
          console.log("login");
          const user = {
            userId: userId,
            name: name,
            email: email,
          };
          localStorage.setItem("user", JSON.stringify(user));
          checkUserInLocalStorage();
          $("#login_modal").modal("hide");
        } else {
          console.log("cant login");
          $("#loginError").text("Email or password not found");
        }
      }

      function signupUser(username, email, password) {
        const existingUser = users.find((user) => user.email === email);
        if (existingUser) {
          $("#signupError").text(
            "Email already exists. Please use a different email"
          );
          return;
        }
        const newUser = {
          userId: users.length + 1,
          name: username,
          email: email,
          password: password,
        };
        const newLocalUser = {
          userId: users.length + 1,
          name: username,
          email: email,
        };
        console.log(newUser);
        users.push(newUser);
        axios
          .put(userApiUrl, users)
          .then((res) => {
            console.log(res.data);
          })
          .catch((err) => {
            console.log(err);
          });

        localStorage.setItem("user", JSON.stringify(newLocalUser));
        $("#signupError").text("");
        checkUserInLocalStorage();
        $("#signup_modal").modal("hide");
      }

      $(document).ready(function () {
        checkUserInLocalStorage();
        $(document).on("click", "#logoutBtn", function () {
          localStorage.removeItem("user");
          location.reload();
        });
        $("#login_modal form").submit(function (e) {
          e.preventDefault();
          const email = $("#loginEmail").val();
          const password = $("#loginPassword").val();
          loginUser(email, password);
        });
        $("#signup_modal form").submit(function (e) {
          e.preventDefault();
          const username = $("#signupUsername").val();
          const email = $("#signupEmail").val();
          const password = $("#signupPassword").val();
          console.log("signup");
          signupUser(username, email, password);
        });
      });

      $(() => {
        $(document).on("click", ".login-btn", function (e) {
          console.log("khanh");
          $("#signup_modal").modal("hide");
          $("#login_modal").modal("show");
        });
        $(document).on("click", ".signup-btn", function (e) {
          console.log("khanh1");
          $("#signup_modal").modal("show");
          $("#login_modal").modal("hide");
        });
        //handle login before add comment and reply
        $(document).on("click", "#btn-add", function (e) {
          user = localStorage.getItem("user");
          console.log("add comment");
          if (!user) {
            $("#login_modal").modal("show");
            e.preventDefault();
            return;
          } else {
            $("#add_modal").modal("show");
          }
        });
        $(document).on("click", ".reply-btn", function (e) {
          user = localStorage.getItem("user");
          if (!user) {
            $("#login_modal").modal("show");
            e.preventDefault();
            return;
          } else {
            $("#reply_modal").modal("show");
          }
        });
        //add comment
        $(document).on("click", "#add-submit", function () {
          user = JSON.parse(localStorage.getItem("user"));
          userId = user?.userId;
          var newComment = {
            userId: userId,
            commentId: generateCommentId(),
            comment: $("#commentAdd").val(),
            upvoteUserId: [],
            downvoteUserId: [],
            replies: [],
          };
          console.log(newComment);

          const countryId = data.findIndex(
            (country) => country.country === countryName
          );
          if (countryId !== -1) {
            const cityId = data[countryId].cities.findIndex(
              (city) => city.city === cityName
            );
            if (cityId !== -1) {
              const placeId = data[countryId].cities[cityId].places.findIndex(
                (place) => place.place === placeName
              );
              if (placeId !== -1) {
                data[countryId].cities[cityId].places[placeId].comments.push(
                  newComment
                );
                // comments.push(newComment);
                updateJsonData(data);
              } else {
                console.log("place not found");
              }
            } else {
              console.log("city not found");
            }
          } else {
            console.log("country not found");
          }

          $("#commentAdd").val("");
          $("#comments-container").empty();
          displayComments(comments);
          $("#add_modal").modal("hide");
        });

        //add reply
        $(document).on("click", "#reply-submit", function () {
          var newReply = {
            userId: userId,
            reply: $("#replyAdd").val(),
          };
          const commentId = parseInt($("#reply_modal").data("commentId"));
          //   console.log(commentId);

          const countryId = data.findIndex(
            (country) => country.country === countryName
          );
          if (countryId !== -1) {
            const cityId = data[countryId].cities.findIndex(
              (city) => city.city === cityName
            );
            if (cityId !== -1) {
              const placeId = data[countryId].cities[cityId].places.findIndex(
                (place) => place.place === placeName
              );
              if (placeId !== -1) {
                const commentIdx = data[countryId].cities[cityId].places[
                  placeId
                ].comments.findIndex(
                  (comment) => comment.commentId === commentId
                );
                if (commentIdx !== -1) {
                  data[countryId].cities[cityId].places[placeId].comments[
                    commentIdx
                  ].replies.push(newReply);

                  //   comments[commentIdx].replies.push(newReply);
                  console.log(comments);
                  updateJsonData(data);
                } else {
                  console.log("comment not found");
                }
              } else {
                console.log("place not found");
              }
            } else {
              console.log("city not found");
            }
          } else {
            console.log("country not found");
          }

          $("#replyAdd").val("");
          $("#comments-container").empty();
          displayComments(comments);
          $("#reply_modal").modal("hide");
        });

        $(document).on("click", ".reply-btn", function () {
          commentId = $(this).attr("id");
          $("#reply_modal").data("commentId", commentId);
        });
      });
    </script>
  </body>
</html>
